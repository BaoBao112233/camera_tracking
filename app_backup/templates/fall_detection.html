<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng ph√°t hi·ªán ng∆∞·ªùi ng√£</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .video-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            position: relative;
        }
        #video-feed {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #0b7dda);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        .alert-danger {
            background: rgba(244, 67, 54, 0.9);
            border: 2px solid #f44336;
        }
        .alert-success {
            background: rgba(76, 175, 80, 0.9);
            border: 2px solid #4CAF50;
        }
        .settings {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .setting-group {
            margin-bottom: 15px;
        }
        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .setting-group input, .setting-group select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        .pose-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .pose-keypoints {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .keypoint {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .fall-image-container {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-top: 15px;
        }
        
        .fall-image-container img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .fall-image-info {
            margin-top: 10px;
            font-size: 12px;
            color: #ddd;
        }
        
        .fall-image-info div {
            margin: 5px 0;
        }
        
        .no-fall-message {
            color: #ccc;
            font-style: italic;
            padding: 20px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 2em;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® H·ªá th·ªëng ph√°t hi·ªán ng∆∞·ªùi ng√£</h1>
        
        <div class="alert alert-danger" id="fall-alert">
            ‚ö†Ô∏è C·∫¢NH B√ÅO: Ph√°t hi·ªán ng∆∞·ªùi ng√£! Th·ªùi gian: <span id="fall-time"></span>
        </div>
        
        <div class="alert alert-success" id="normal-alert">
            ‚úÖ H·ªá th·ªëng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
        </div>
        
        <div class="video-container">
            <img id="video-feed" src="/fall_detection_feed" alt="Fall Detection Feed">
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="startDetection()">üé• B·∫Øt ƒë·∫ßu ph√°t hi·ªán</button>
            <button class="btn btn-danger" onclick="stopDetection()">‚èπÔ∏è D·ª´ng ph√°t hi·ªán</button>
            <button class="btn btn-secondary" onclick="resetStats()">üîÑ Reset th·ªëng k√™</button>
            <a href="/" class="btn btn-secondary">üè† V·ªÅ trang ch·ªß</a>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-falls">0</div>
                <div class="stat-label">T·ªïng s·ªë l·∫ßn ng√£</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="people-detected">0</div>
                <div class="stat-label">Ng∆∞·ªùi ƒë∆∞·ª£c ph√°t hi·ªán</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="detection-status">ƒêang ch·ªù</div>
                <div class="stat-label">Tr·∫°ng th√°i h·ªá th·ªëng</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="last-fall-time">Ch∆∞a c√≥</div>
                <div class="stat-label">L·∫ßn ng√£ cu·ªëi</div>
            </div>
        </div>
        
        <div class="settings">
            <h3>‚öôÔ∏è C√†i ƒë·∫∑t ph√°t hi·ªán</h3>
            <div class="setting-group">
                <label for="sensitivity">ƒê·ªô nh·∫°y ph√°t hi·ªán:</label>
                <select id="sensitivity" onchange="updateSensitivity()">
                    <option value="low">Th·∫•p</option>
                    <option value="medium" selected>Trung b√¨nh</option>
                    <option value="high">Cao</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="confidence-threshold">Ng∆∞·ª°ng tin c·∫≠y (%):</label>
                <input type="range" id="confidence-threshold" min="30" max="90" value="60" onchange="updateConfidence()">
                <span id="confidence-value">60%</span>
            </div>
            <div class="setting-group">
                <label for="alert-sound">√Çm thanh c·∫£nh b√°o:</label>
                <select id="alert-sound" onchange="updateAlertSound()">
                    <option value="enabled" selected>B·∫≠t</option>
                    <option value="disabled">T·∫Øt</option>
                </select>
            </div>
        </div>
        
        <div class="pose-info">
            <h3>üìä Th√¥ng tin ph√°t hi·ªán & ·∫¢nh ng√£ cu·ªëi c√πng</h3>
            
            <!-- ·∫¢nh ng√£ cu·ªëi c√πng -->
            <div class="last-fall-image" style="margin-bottom: 20px;">
                <h4>üñºÔ∏è ·∫¢nh ng√£ cu·ªëi c√πng:</h4>
                <div id="last-fall-container" style="text-align: center; background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
                    <img id="last-fall-image" src="" alt="Ch∆∞a c√≥ ·∫£nh ng√£" style="max-width: 100%; max-height: 300px; border-radius: 10px; display: none;">
                    <div id="no-fall-message" style="color: #ccc; font-style: italic;">Ch∆∞a c√≥ ·∫£nh ng√£ n√†o ƒë∆∞·ª£c l∆∞u</div>
                    <div id="fall-image-info" style="margin-top: 10px; font-size: 0.9em; color: #ddd; display: none;">
                        <div>Th·ªùi gian: <span id="fall-image-time"></span></div>
                        <div>Tracker ID: <span id="fall-image-tracker"></span></div>
                    </div>
                </div>
            </div>
            
            <!-- Th√¥ng tin keypoints -->
            <div class="pose-keypoints-section">
                <h4>üéØ Th√¥ng tin t∆∞ th·∫ø hi·ªán t·∫°i:</h4>
                <div class="pose-keypoints" id="pose-keypoints">
                    <!-- Pose keypoints s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let detectionActive = false;
        let totalFalls = 0;
        let peopleDetected = 0;
        let lastFallTime = null;
        
        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            showAlert('normal');
            restoreLastFallImage(); // Kh√¥i ph·ª•c ·∫£nh ng√£ cu·ªëi c√πng
            
            // C·∫≠p nh·∫≠t stats m·ªói 2 gi√¢y
            setInterval(fetchStats, 2000);
        });
        
        /**
         * B·∫Øt ƒë·∫ßu ph√°t hi·ªán ng∆∞·ªùi ng√£
         */
        function startDetection() {
            detectionActive = true;
            document.getElementById('detection-status').textContent = 'ƒêang ho·∫°t ƒë·ªông';
            document.getElementById('video-feed').src = '/fall_detection_feed?' + new Date().getTime();
            showAlert('normal');
            
            fetch('/start_fall_detection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }
        
        /**
         * D·ª´ng ph√°t hi·ªán ng∆∞·ªùi ng√£
         */
        function stopDetection() {
            detectionActive = false;
            document.getElementById('detection-status').textContent = 'ƒê√£ d·ª´ng';
            document.getElementById('video-feed').src = '';
            
            fetch('/stop_fall_detection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }
        
        /**
         * Reset th·ªëng k√™
         */
        function resetStats() {
            totalFalls = 0;
            peopleDetected = 0;
            lastFallTime = null;
            updateStats();
            
            fetch('/reset_fall_stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }
        
        /**
         * C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªëng k√™
         */
        function updateStats() {
            document.getElementById('total-falls').textContent = totalFalls;
            document.getElementById('people-detected').textContent = peopleDetected;
            document.getElementById('last-fall-time').textContent = lastFallTime || 'Ch∆∞a c√≥';
        }
        
        /**
         * L·∫•y th·ªëng k√™ t·ª´ server
         */
        function fetchStats() {
            if (!detectionActive) return;
            
            fetch('/fall_detection_stats')
                .then(response => response.json())
                .then(data => {
                    totalFalls = data.total_falls || 0;
                    peopleDetected = data.people_detected || 0;
                    
                    if (data.fall_detected) {
                        lastFallTime = new Date().toLocaleTimeString('vi-VN');
                        showFallAlert();
                        playAlertSound();
                        
                        // L∆∞u ·∫£nh ng√£ cu·ªëi c√πng
                        saveFallImage(data.last_fall_tracker_id);
                    }
                    
                    updateStats();
                    updatePoseInfo(data.pose_data);
                })
                .catch(error => {
                    console.error('L·ªói khi l·∫•y th·ªëng k√™:', error);
                });
        }
        
        /**
         * Hi·ªÉn th·ªã c·∫£nh b√°o
         */
        function showAlert(type) {
            const fallAlert = document.getElementById('fall-alert');
            const normalAlert = document.getElementById('normal-alert');
            
            if (type === 'fall') {
                fallAlert.style.display = 'block';
                normalAlert.style.display = 'none';
            } else {
                fallAlert.style.display = 'none';
                normalAlert.style.display = 'block';
            }
        }
        
        /**
         * Hi·ªÉn th·ªã c·∫£nh b√°o ng∆∞·ªùi ng√£
         */
        function showFallAlert() {
            const currentTime = new Date().toLocaleTimeString('vi-VN');
            document.getElementById('fall-time').textContent = currentTime;
            showAlert('fall');
            
            // T·ª± ƒë·ªông ·∫©n c·∫£nh b√°o sau 5 gi√¢y
            setTimeout(() => {
                showAlert('normal');
            }, 5000);
        }
        
        /**
         * Ph√°t √¢m thanh c·∫£nh b√°o
         */
        function playAlertSound() {
            const alertSound = document.getElementById('alert-sound').value;
            if (alertSound === 'enabled') {
                // T·∫°o √¢m thanh c·∫£nh b√°o
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }
        
        /**
         * C·∫≠p nh·∫≠t ƒë·ªô nh·∫°y
         */
        function updateSensitivity() {
            const sensitivity = document.getElementById('sensitivity').value;
            fetch('/update_fall_sensitivity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sensitivity: sensitivity })
            });
        }
        
        /**
         * C·∫≠p nh·∫≠t ng∆∞·ª°ng tin c·∫≠y
         */
        function updateConfidence() {
            const confidence = document.getElementById('confidence-threshold').value;
            document.getElementById('confidence-value').textContent = confidence + '%';
            
            fetch('/update_fall_confidence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ confidence: parseFloat(confidence) / 100 })
            });
        }
        
        /**
         * C·∫≠p nh·∫≠t c√†i ƒë·∫∑t √¢m thanh
         */
        function updateAlertSound() {
            // L∆∞u c√†i ƒë·∫∑t v√†o localStorage
            const alertSound = document.getElementById('alert-sound').value;
            localStorage.setItem('alertSound', alertSound);
        }
        
        /**
         * L∆∞u ·∫£nh ng√£ cu·ªëi c√πng
         */
        function saveFallImage(trackerId) {
            // L·∫•y frame hi·ªán t·∫°i t·ª´ video feed
            const videoFeed = document.getElementById('video-feed');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // T·∫°o ·∫£nh t·ª´ video feed hi·ªán t·∫°i
            canvas.width = videoFeed.naturalWidth || videoFeed.width;
            canvas.height = videoFeed.naturalHeight || videoFeed.height;
            
            // V·∫Ω ·∫£nh hi·ªán t·∫°i l√™n canvas
            ctx.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
            
            // Chuy·ªÉn ƒë·ªïi th√†nh base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Hi·ªÉn th·ªã ·∫£nh ng√£ cu·ªëi c√πng
            displayLastFallImage(imageData, trackerId);
            
            // L∆∞u v√†o localStorage ƒë·ªÉ gi·ªØ l·∫°i khi reload trang
            const fallImageData = {
                image: imageData,
                time: new Date().toLocaleString('vi-VN'),
                trackerId: trackerId
            };
            localStorage.setItem('lastFallImage', JSON.stringify(fallImageData));
        }
        
        /**
         * Hi·ªÉn th·ªã ·∫£nh ng√£ cu·ªëi c√πng
         */
        function displayLastFallImage(imageData, trackerId) {
            const lastFallImage = document.getElementById('last-fall-image');
            const noFallMessage = document.getElementById('no-fall-message');
            const fallImageInfo = document.getElementById('fall-image-info');
            const fallImageTime = document.getElementById('fall-image-time');
            const fallImageTracker = document.getElementById('fall-image-tracker');
            
            // Hi·ªÉn th·ªã ·∫£nh
            lastFallImage.src = imageData;
            lastFallImage.style.display = 'block';
            noFallMessage.style.display = 'none';
            
            // Hi·ªÉn th·ªã th√¥ng tin
            fallImageTime.textContent = new Date().toLocaleString('vi-VN');
            fallImageTracker.textContent = trackerId || 'N/A';
            fallImageInfo.style.display = 'block';
        }
        
        /**
         * Kh√¥i ph·ª•c ·∫£nh ng√£ cu·ªëi c√πng t·ª´ localStorage
         */
        function restoreLastFallImage() {
            const savedFallImage = localStorage.getItem('lastFallImage');
            if (savedFallImage) {
                try {
                    const fallImageData = JSON.parse(savedFallImage);
                    const lastFallImage = document.getElementById('last-fall-image');
                    const noFallMessage = document.getElementById('no-fall-message');
                    const fallImageInfo = document.getElementById('fall-image-info');
                    const fallImageTime = document.getElementById('fall-image-time');
                    const fallImageTracker = document.getElementById('fall-image-tracker');
                    
                    // Hi·ªÉn th·ªã ·∫£nh ƒë√£ l∆∞u
                    lastFallImage.src = fallImageData.image;
                    lastFallImage.style.display = 'block';
                    noFallMessage.style.display = 'none';
                    
                    // Hi·ªÉn th·ªã th√¥ng tin ƒë√£ l∆∞u
                    fallImageTime.textContent = fallImageData.time;
                    fallImageTracker.textContent = fallImageData.trackerId || 'N/A';
                    fallImageInfo.style.display = 'block';
                } catch (error) {
                    console.error('L·ªói khi kh√¥i ph·ª•c ·∫£nh ng√£:', error);
                }
            }
        }
        
        /**
         * C·∫≠p nh·∫≠t th√¥ng tin t∆∞ th·∫ø
         */
        function updatePoseInfo(poseData) {
            const keypointsContainer = document.getElementById('pose-keypoints');
            
            if (!poseData || !poseData.keypoints) {
                keypointsContainer.innerHTML = '<div class="keypoint">Kh√¥ng c√≥ d·ªØ li·ªáu t∆∞ th·∫ø</div>';
                return;
            }
            
            const keypointNames = [
                'M≈©i', 'M·∫Øt tr√°i', 'M·∫Øt ph·∫£i', 'Tai tr√°i', 'Tai ph·∫£i',
                'Vai tr√°i', 'Vai ph·∫£i', 'Khu·ª∑u tr√°i', 'Khu·ª∑u ph·∫£i',
                'C·ªï tay tr√°i', 'C·ªï tay ph·∫£i', 'H√¥ng tr√°i', 'H√¥ng ph·∫£i',
                'ƒê·∫ßu g·ªëi tr√°i', 'ƒê·∫ßu g·ªëi ph·∫£i', 'M·∫Øt c√° tr√°i', 'M·∫Øt c√° ph·∫£i'
            ];
            
            let html = '';
            poseData.keypoints.forEach((keypoint, index) => {
                if (index < keypointNames.length) {
                    const confidence = (keypoint.confidence * 100).toFixed(1);
                    html += `
                        <div class="keypoint">
                            <strong>${keypointNames[index]}</strong><br>
                            Tin c·∫≠y: ${confidence}%
                        </div>
                    `;
                }
            });
            
            keypointsContainer.innerHTML = html;
        }
        
        // Kh√¥i ph·ª•c c√†i ƒë·∫∑t t·ª´ localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedAlertSound = localStorage.getItem('alertSound');
            if (savedAlertSound) {
                document.getElementById('alert-sound').value = savedAlertSound;
            }
            
            // Kh√¥i ph·ª•c ·∫£nh ng√£ cu·ªëi c√πng
            restoreLastFallImage();
        });
    </script>
</body>
</html>